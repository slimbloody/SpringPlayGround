----------------------------------------

InfoQ：你曾在网易工作过，能否简单谈谈在架构设计上美团外卖与网易各自的特点是什么？
曹振团：门户网站面对着海量的新闻事件及分类，具有更新量大、过期快和热点集中的特点。新闻资料基本是静态的，所以对缓存技术应用较多。
美团外卖涉及到交易的信息、支付、履约的各个环节，参与方较多。从用户支付下单到商家接单，还有骑手配送等环节，这些过程都是动态有交互的，美团外卖对服务化及服务治理设计较多。

----------------------------------------

InfoQ：你加入美团后有参与多个创新业务的探索，那么你认为在业务初期好的架构是必要的吗，为什么呢？能否分享经历了多个创新业务之后的收获，这些经验给美团外卖带来了什么样的收获和挑战？
加入新美大的早期参与公司内部的创业，在O2O这个领域进行了多个创新业务的探索，最后决定做外卖这个业务。在经历创新业务后最大的收获主要讲两点：
1. 创业的早期决定不做什么往往比决定做什么更重要。在早期产品技术资源都很紧缺，需要将有限的资源投入到最核心的产品需求上。
2. 天下武功唯快不破。如今的市场瞬息万变，唯有快速的迭代，方能抢占先机。

O2O即Online To Offline（在线离线/线上到线下），是指将线下的商务机会与互联网结合，让互联网成为线下交易的平台，这个概念最早来源于美国。O2O的概念非常广泛，既可涉及到线上，又可涉及到线下,可以通称为O2O。

----------------------------------------

InfoQ：美团外卖创建初期是否借鉴了美团的架构设计？美团外卖架构的创建和发展经历了什么样的过程？
曹振团：美团外卖创建初期复用了很多美团的基础服务，主要借鉴了团购业务积累的经验。 美团外卖的架构是随着业务的发展优化和演进的。主要经历了以下几个过程：

1. 自由发展阶段：业务起步的时候，大家公用服务和数据库表，这样能够快速支持产品迭代。产品和技术人员聚焦在快速验证产品功能上。到底应该有哪些功能，用户会如何点外卖等？这个阶段主要的特点就是集中，所有的功能都集中在几个项目里，所有的表都集中在一个库中。
2. 故障驱动架构：随着业务的爆发增长，早期的架构出现了很多的问题，系统频繁地出现稳定性的问题，共享数据库表导致业务逻辑散落各地、甚至实现不一致的情况。这时系统稳定性问题倒逼架构进行优化调整，进行了服务化拆分，服务之间全部用接口的方式调用。
3. 架构驱动改革：随着单量的快速增长，系统故障所造成的损失是巨大的、不可接受的。需要从架构驱动技术体系的改进、甚至推进产品和业务的变革。同时增加业务的容灾能力，进行了多机房的部署。

----------------------------------------

InfoQ：在外卖交易流程中，哪个环节最容易出现问题，你们是如何解决的？
曹振团：美团外卖在快速发展的过程中踩了很多坑。比如发版引发的故障，这类问题一般是最多的。发版的新功能可能含有bug，可能含有慢SQL，可能没有正确处理网络异常等。外卖业务还是一个实时且流程较长的业务，尤其流量比较集中在中午和晚上的饭点，在高峰时段的QPS是万级别的，外卖整个链条还会涉及到很多的服务，如果某个依赖服务有问题将会影响到其它服务。例如没有设置合理的RPC超时时间，如果服务A挂了，会导致依赖该服务的其它服务出现问题，进而引起连锁反应，最终系统雪崩。

针对这些问题，我们做了关键路径梳理。整个交易流程中梳理出关键路径，非关键调用异步化，关键路径做好容错容灾设计，实时监控关键路径的核心指标。整体系统做了比较全面的应急预案，当有紧急情况发生时，力保关键路径不出问题。

至于如何避免掉坑，分享几点：
1. 防御式编程，不要相信任何人或服务，做好对自身服务的保护和对依赖服务的熔断。
2. 每次发版都有预案。回滚是解决发版引发故障的最快捷有效的手段。
3. 灰度！灰度！灰度！
4. 完善的监控很重要，需要覆盖系统性能及业务指标，并对这些指标熟知和敏感。

----------------------------------------

InfoQ： 在美团外卖业务急速发展的同时，目前美团外卖架构上是否有需要改进和突破的地方？是否有关注前沿的技术，目前通过什么渠道来发现持续优化架构的方法？

曹振团： 业务屡创新高及团队规模的扩大，给技术架构带来了越来越多的挑战。如何能够在大规模作战的情况下，既能保持业务开发的敏捷性又能保障系统的稳定性，是我们架构中要重点思考的，我们一直在结合着业务发展的节奏，优化和改进技术架构。
一方面要与时俱进地支持多品类的业务扩展及平台化建设；
另一方面，在永恒不变的话题“稳定性”方面，在为能够支持更高的业务量，持续抽取和优化基础服务，加强中间件的能力，使各服务能够更聚焦和专注。因此加强基础设施和强固中间件的建设是我们要改进和突破的地方。夯实技术基础设施和中间件，让研发力量更聚焦在业务开发中。(阿里云替代)
美团外卖在技术架构中大量使用了开源的技术组件，在深入调研后会结合外卖的业务特点做二次开发，感谢Java社区里丰富的开源软件，使得我们能够更好地优化我们的架构。另外一个发现和持续优化架构的方法是全链路的在线压测。我们会定期进行全链路的在线压测，发现系统的瓶颈并优化验证。
(todo:全链路压测)

----------------------------------------

InfoQ： 在架构演进过程中分别使用了哪些核心指标来判断公司架构是否改善？你们对核心指标的要求是多少，目前是否已经稳定达到？
曹振团：架构的演进是为了能够提供更可靠的SLA，核心的考量指标有：5倍的容量，4个9的可用性，TP99 200ms的响应时间，目前已经可以稳定达到了。这些指标界定了系统能够在一定的容量下具有稳定和可靠的表现。我们会定期地做全链路的在线压测，通过实时的数据指标监控系统分析和验证是否已经达成架构目标。可用性和响应时间在服务端还是比较好衡量和达成的，但是从用户端看就变得复杂了很多。比如用户的设备、网络环境等都可能会对结果造成影响，我们也在加强用户侧的监控，持续地优化和改进用户体验。


The tp90 is a minimum time under which 90% of requests have been served.
tp90 = top percentile 90
----------------------------------------
